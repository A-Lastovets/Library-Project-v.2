<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
</head>
<body>
  <h2>Login</h2>
  <form id="login-form">
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="password" id="password" placeholder="Password" required><br>
    <button type="submit">Login</button>
  </form>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const res = await fetch('http://localhost:8000/api/v1/auth/sign-in', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
        credentials: 'include' // üîê –∫—É–∫–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
      });

      if (res.ok) {
        setTimeout(() => {
          const token = getCookie("access_token");
          if (!token) {
            alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω. –ü–µ—Ä–µ–≤—ñ—Ä –±–µ–∫–µ–Ω–¥ –∞–±–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Secure/HttpOnly.");
            return;
          }

          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const role = payload.role;

            if (role === 'reader') {
              location.href = '/html/start_chat.html';
            } else {
              location.href = '/html/queue_client.html';
            }
          } catch (e) {
            alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ –∞–±–æ —Ä–æ–ª—ñ.");
          }
        }, 300); // –ù–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞, —â–æ–± –∫—É–∫–∏ —Ç–æ—á–Ω–æ –∑–±–µ—Ä–µ–≥–ª–∏—Å—å
      } else {
        alert('‚ùå –ù–µ–≤–¥–∞–ª–∏–π –ª–æ–≥—ñ–Ω. –ü–µ—Ä–µ–≤—ñ—Ä email –∞–±–æ –ø–∞—Ä–æ–ª—å.');
      }
    });
  </script>
</body>
</html>
